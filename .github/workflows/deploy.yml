name: Deploy

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Run Tests First (Quality Gate)
  # ============================================
  test:
    name: Run Test Suite
    uses: ./.github/workflows/test.yml

  # ============================================
  # Deploy to Staging
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.codeframe.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Create environment file
        env:
          REMOTE_HOST: ${{ secrets.HOST }}
          REMOTE_USER: ${{ secrets.USER }}
          REMOTE_PATH: ${{ secrets.PROJECT_PATH }}
          ENV_ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENV_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          ENV_DATABASE_PATH: ${{ secrets.DATABASE_PATH }}
          ENV_API_HOST: ${{ secrets.API_HOST }}
          ENV_API_PORT: ${{ secrets.API_PORT }}
          ENV_CORS: ${{ secrets.CORS_ORIGINS }}
          ENV_API_URL: ${{ secrets.API_URL }}
          ENV_WS_URL: ${{ secrets.WS_URL }}
          ENV_LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          ENV_LOG_FILE: ${{ secrets.LOG_FILE }}
          ENV_ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
          ENV_DEBUG: ${{ secrets.DEBUG }}
          ENV_HOT_RELOAD: ${{ secrets.HOT_RELOAD }}
        run: |
          echo "ðŸ“ Creating .env.staging file..."
          ssh ${REMOTE_USER}@${REMOTE_HOST} "cat > ${REMOTE_PATH}/.env.staging && chmod 600 ${REMOTE_PATH}/.env.staging" << ENVEOF
          # CodeFRAME Environment Configuration
          # Auto-generated by GitHub Actions deployment

          # AI Provider API Keys
          ANTHROPIC_API_KEY=${ENV_ANTHROPIC_KEY}
          OPENAI_API_KEY=${ENV_OPENAI_KEY}

          # Database Configuration
          DATABASE_PATH=${ENV_DATABASE_PATH}

          # Status Server Configuration
          API_HOST=${ENV_API_HOST}
          API_PORT=${ENV_API_PORT}
          CORS_ALLOWED_ORIGINS=${ENV_CORS}

          # Web UI Configuration
          NEXT_PUBLIC_API_URL=${ENV_API_URL}
          NEXT_PUBLIC_WS_URL=${ENV_WS_URL}

          # Logging Configuration
          LOG_LEVEL=${ENV_LOG_LEVEL}
          LOG_FILE=${ENV_LOG_FILE}

          # Environment & Development Flags
          ENVIRONMENT=${ENV_ENVIRONMENT}
          DEBUG=${ENV_DEBUG}
          HOT_RELOAD=${ENV_HOT_RELOAD}
          ENVEOF
          echo "âœ… .env.staging created"

      - name: Deploy to staging server
        run: |
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "bash -s" << ENDSSH
            set -e
            echo "ðŸš€ Starting deployment to staging..."

            # Navigate to project directory
            cd ${{ secrets.PROJECT_PATH }}

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Backend setup
            echo "ðŸ Setting up Python backend..."
            if [ -d .venv ]; then
              source .venv/bin/activate
            else
              python3 -m venv .venv
              source .venv/bin/activate
            fi
            pip install --quiet uv
            uv sync

            # Frontend setup
            echo "ðŸ“¦ Building frontend..."
            cd web-ui
            npm ci
            npm run build
            cd ..

            # Ensure logs directory exists
            mkdir -p logs

            # Restart PM2 services
            echo "ðŸ”„ Restarting PM2 services..."
            if command -v pm2 &> /dev/null; then
              CONFIG_FILE="ecosystem.staging.config.js"
              APP_NAME="codeframe-staging"

              # Check if PM2 processes exist, if not start them
              if pm2 describe "\${APP_NAME}-backend" > /dev/null 2>&1; then
                pm2 restart \${CONFIG_FILE}
                echo "âœ… PM2 services restarted"
              else
                pm2 start \${CONFIG_FILE}
                echo "âœ… PM2 services started"
              fi
              pm2 save
            else
              echo "âŒ PM2 not found - please install PM2 globally"
              exit 1
            fi

            echo "âœ… Deployment to staging complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 10
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "curl -sf http://localhost:${{ secrets.API_PORT }}/health" || echo "âš ï¸  Health check failed or endpoint not available"

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy to Production
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.event_name == 'release') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://codeframe.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Create environment file
        env:
          REMOTE_HOST: ${{ secrets.HOST }}
          REMOTE_USER: ${{ secrets.USER }}
          REMOTE_PATH: ${{ secrets.PROJECT_PATH }}
          ENV_ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENV_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          ENV_DATABASE_PATH: ${{ secrets.DATABASE_PATH }}
          ENV_API_HOST: ${{ secrets.API_HOST }}
          ENV_API_PORT: ${{ secrets.API_PORT }}
          ENV_CORS: ${{ secrets.CORS_ORIGINS }}
          ENV_API_URL: ${{ secrets.API_URL }}
          ENV_WS_URL: ${{ secrets.WS_URL }}
          ENV_LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          ENV_LOG_FILE: ${{ secrets.LOG_FILE }}
          ENV_ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
          ENV_DEBUG: ${{ secrets.DEBUG }}
          ENV_HOT_RELOAD: ${{ secrets.HOT_RELOAD }}
        run: |
          echo "ðŸ“ Creating .env.production file..."
          ssh ${REMOTE_USER}@${REMOTE_HOST} "cat > ${REMOTE_PATH}/.env.production && chmod 600 ${REMOTE_PATH}/.env.production" << ENVEOF
          # CodeFRAME Environment Configuration
          # Auto-generated by GitHub Actions deployment

          # AI Provider API Keys
          ANTHROPIC_API_KEY=${ENV_ANTHROPIC_KEY}
          OPENAI_API_KEY=${ENV_OPENAI_KEY}

          # Database Configuration
          DATABASE_PATH=${ENV_DATABASE_PATH}

          # Status Server Configuration
          API_HOST=${ENV_API_HOST}
          API_PORT=${ENV_API_PORT}
          CORS_ALLOWED_ORIGINS=${ENV_CORS}

          # Web UI Configuration
          NEXT_PUBLIC_API_URL=${ENV_API_URL}
          NEXT_PUBLIC_WS_URL=${ENV_WS_URL}

          # Logging Configuration
          LOG_LEVEL=${ENV_LOG_LEVEL}
          LOG_FILE=${ENV_LOG_FILE}

          # Environment & Development Flags
          ENVIRONMENT=${ENV_ENVIRONMENT}
          DEBUG=${ENV_DEBUG}
          HOT_RELOAD=${ENV_HOT_RELOAD}
          ENVEOF
          echo "âœ… .env.production created"

      - name: Create pre-deployment backup
        run: |
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "bash -s" << ENDSSH
            set -e
            echo "ðŸ’¾ Creating pre-deployment backup..."
            cd ${{ secrets.PROJECT_PATH }}

            # Create backup directory
            BACKUP_DIR="/tmp/codeframe-backup-\$(date +%Y%m%d-%H%M%S)"
            mkdir -p \$BACKUP_DIR

            # Backup database
            if [ -f .codeframe/state.db ]; then
              cp .codeframe/state.db \$BACKUP_DIR/
              echo "âœ… Database backed up to \$BACKUP_DIR"
            fi

            # Record current commit for potential rollback
            git rev-parse HEAD > \$BACKUP_DIR/previous_commit.txt
            echo "âœ… Current commit recorded: \$(cat \$BACKUP_DIR/previous_commit.txt)"
          ENDSSH

      - name: Deploy to production server
        run: |
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "bash -s" << ENDSSH
            set -e
            echo "ðŸš€ Starting deployment to production..."

            # Navigate to project directory
            cd ${{ secrets.PROJECT_PATH }}

            # Pull the release tag or main
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin --tags
            TAG_NAME="${{ github.event.release.tag_name }}"
            if [ -n "\$TAG_NAME" ]; then
              git checkout \$TAG_NAME
              echo "âœ… Checked out tag: \$TAG_NAME"
            else
              git fetch origin main
              git reset --hard origin/main
              echo "âœ… Reset to origin/main"
            fi

            # Backend setup
            echo "ðŸ Setting up Python backend..."
            if [ -d .venv ]; then
              source .venv/bin/activate
            else
              python3 -m venv .venv
              source .venv/bin/activate
            fi
            pip install --quiet uv
            uv sync --no-dev

            # Frontend setup (production build)
            echo "ðŸ“¦ Building frontend for production..."
            cd web-ui
            npm ci
            npm run build
            cd ..

            # Run database migrations if any
            echo "ðŸ—ƒï¸ Running database migrations..."
            # Add migration command here if needed

            # Ensure logs directory exists
            mkdir -p logs

            # Restart PM2 services
            echo "ðŸ”„ Restarting PM2 services..."
            if command -v pm2 &> /dev/null; then
              CONFIG_FILE="ecosystem.production.config.js"
              APP_NAME="codeframe-production"

              # Check if PM2 processes exist, if not start them
              if pm2 describe "\${APP_NAME}-backend" > /dev/null 2>&1; then
                pm2 restart \${CONFIG_FILE}
                echo "âœ… PM2 services restarted"
              else
                pm2 start \${CONFIG_FILE}
                echo "âœ… PM2 services started"
              fi
              pm2 save
            else
              echo "âŒ PM2 not found - please install PM2 globally"
              exit 1
            fi

            echo "âœ… Deployment to production complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying production deployment..."
          sleep 15
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "curl -sf http://localhost:${{ secrets.API_PORT }}/health" || echo "âš ï¸  Health check failed or endpoint not available"

      - name: Deployment summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.event.release.tag_name || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

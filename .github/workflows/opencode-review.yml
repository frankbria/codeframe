name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize]
    # Skip review for documentation and config-only changes
    paths-ignore:
      - "**/*.md"
      - ".github/**"
      - ".gitignore"
      - "pyproject.toml"

jobs:
  opencode-review:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Calculate total changes
        id: calc
        run: |
          additions=${{ github.event.pull_request.additions }}
          deletions=${{ github.event.pull_request.deletions }}
          total=$((additions + deletions))
          echo "total=$total" >> $GITHUB_OUTPUT

      - name: Checkout repository
        # Only review substantial changes (5+ files OR 20+ lines changed)
        if: |
          github.event.pull_request.changed_files >= 5 ||
          steps.calc.outputs.total >= 20
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Clear git extraheader to avoid duplicate auth
        if: |
          github.event.pull_request.changed_files >= 5 ||
          steps.calc.outputs.total >= 20
        run: git config --local --unset-all http.https://github.com/.extraheader || true

      - name: Run OpenCode PR Review
        # Only review substantial changes (5+ files OR 20+ lines changed)
        if: |
          github.event.pull_request.changed_files >= 5 ||
          steps.calc.outputs.total >= 20
        uses: anomalyco/opencode/github@latest
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          # Pass PR context as environment variables for the review
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          REPO_NAME: ${{ github.repository }}
        with:
          model: zai-coding-plan/glm-4.7
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in repository ${{ github.repository }}.

            PR TITLE: ${{ github.event.pull_request.title }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            IMPORTANT NOTES:
            - Review the other comments on the pull request - including any prior reviews.
            - If you are reviewing changes beyond the first creation of the pull request,
              make sure your comments are consistent with previous reviews.
            - There's no need to repeat information unless it is critical and not
              being reflected in comments or code.
            - Be aware of prior reviews and that new file information may reflect
              changes because of previous reviews.

            Use the repository's CLAUDE.md for guidance on style and conventions.
            Be constructive and helpful in your feedback.

            Use `gh pr comment` to leave your review as a comment on the PR.

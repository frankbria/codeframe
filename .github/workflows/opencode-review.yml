name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize]
    # Skip review for documentation-only changes
    # Exclude this workflow file to prevent self-triggering loops
    paths-ignore:
      - "**/*.md"
      - ".github/workflows/opencode-review.yml"
      - ".gitignore"

# Cancel in-progress runs for the same PR to avoid duplicate reviews
concurrency:
  group: opencode-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  opencode-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging - kill after 10 min
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Calculate total changes
        id: calc
        run: |
          additions="${{ github.event.pull_request.additions }}"
          deletions="${{ github.event.pull_request.deletions }}"
          total=$((additions + deletions))
          echo "total=$total" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        # Only review substantial changes (5+ files OR 20+ lines changed)
        if: |
          github.event.pull_request.changed_files >= 5 ||
          steps.calc.outputs.total >= 20
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Run OpenCode PR Review
        # Only review substantial changes (5+ files OR 20+ lines changed)
        if: |
          github.event.pull_request.changed_files >= 5 ||
          steps.calc.outputs.total >= 20
        uses: anomalyco/opencode/github@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        with:
          model: zai-coding-plan/glm-4.7
          use_github_token: true
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in repository ${{ github.repository }}.

            Use `gh pr view ${{ github.event.pull_request.number }}` to read the PR title and description.
            Use `gh pr diff ${{ github.event.pull_request.number }}` to read the changed files.

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            IMPORTANT NOTES:
            - Review the other comments on the pull request - including any prior reviews.
            - If you are reviewing changes beyond the first creation of the pull request,
              make sure your comments are consistent with previous reviews.
            - There's no need to repeat information unless it is critical and not
              being reflected in comments or code.
            - Be aware of prior reviews and that new file information may reflect
              changes because of previous reviews.

            Use the repository's CLAUDE.md for guidance on style and conventions.
            Be constructive and helpful in your feedback.

            IMPORTANT: Post exactly ONE comment using `gh pr comment`, then STOP.
            Do not attempt additional actions after posting your review.

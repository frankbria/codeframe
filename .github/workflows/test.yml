name: Test Suite (Unit + E2E)

on:
  push:
    branches: [main, develop, '0*']
  pull_request:
    branches: [main, develop]
  workflow_call:  # Allow this workflow to be called by other workflows
  # schedule:
    # Run E2E tests nightly at 2 AM UTC
    # - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Code Quality Checks (Run First - Fast Fail)
  # ============================================
  code-quality:
    name: Code Quality (Lint + Type Check)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run ruff (linting)
        run: uv run ruff check .

      - name: Run mypy (type checking)
        run: uv run mypy codeframe/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install frontend dependencies
        working-directory: web-ui
        run: npm ci

      - name: Run ESLint
        working-directory: web-ui
        run: npm run lint -- --strict

      - name: Run TypeScript type checking
        working-directory: web-ui
        run: npm run type-check

  # ============================================
  # Backend Unit Tests (After Code Quality)
  # ============================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Configure git for tests
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Run pytest with coverage
        run: |
          uv run pytest tests/ \
            --ignore=tests/e2e \
            --cov=codeframe \
            --cov-report=term \
            --cov-report=xml \
            --cov-report=html \
            -v

      - name: Check coverage threshold (65%)
        run: |
          COVERAGE=$(uv run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 65" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below 65% threshold"
            exit 1
          else
            echo "✅ Coverage ${COVERAGE}% meets 65% threshold"
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage

  # ============================================
  # Frontend Unit Tests (After Code Quality)
  # ============================================
  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Install dependencies
        working-directory: web-ui
        run: npm ci

      - name: Run Jest tests with coverage
        working-directory: web-ui
        run: npm run test:coverage

      - name: Check coverage threshold (65%)
        working-directory: web-ui
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 65" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below 65% threshold"
            exit 1
          else
            echo "✅ Coverage ${COVERAGE}% meets 65% threshold"
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          directory: web-ui/coverage
          flags: frontend
          name: frontend-coverage

  # ============================================
  # E2E Backend Tests (Pytest)
  # ============================================
  e2e-backend-tests:
    name: E2E Backend Tests
    runs-on: ubuntu-latest
    # Only run on main branch or scheduled runs (not every PR)
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Initialize git for E2E tests
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install codeframe package
        run: |
          uv pip install -e .
          echo "✅ Package installed in editable mode"

      - name: Initialize database
        run: |
          mkdir -p .codeframe
          source .venv/bin/activate
          python -c "from codeframe.persistence.database import Database; db = Database('.codeframe/state.db'); db.initialize(); db.close()"
          echo "✅ Database initialized"

      - name: Start FastAPI server in background
        env:
          DATABASE_PATH: ${{ github.workspace }}/.codeframe/state.db
          WORKSPACE_ROOT: ${{ github.workspace }}
          CODEFRAME_DEPLOYMENT_MODE: self_hosted
        run: |
          source .venv/bin/activate
          python -m uvicorn codeframe.ui.server:app --port 8080 > /tmp/server.log 2>&1 &
          echo "BACKEND_PID=$!" >> $GITHUB_ENV
          echo "Server started with PID: $!"

      - name: Verify server startup
        run: |
          sleep 5
          if ! ps -p $BACKEND_PID > /dev/null; then
            echo "❌ Server process died immediately"
            cat /tmp/server.log
            exit 1
          fi
          echo "✅ Server process is running (PID: $BACKEND_PID)"

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..120}; do
            if curl -s http://localhost:8080/health > /dev/null; then
              echo "✅ Server is ready!"
              curl -s http://localhost:8080/health | jq .
              exit 0
            fi
            echo "Attempt $i/120: Server not ready yet..."
            sleep 1
          done
          echo "❌ Server failed to start within 120 seconds"
          echo "=== Server Logs ==="
          cat /tmp/server.log
          exit 1

      - name: Run E2E backend tests
        run: |
          uv run pytest tests/e2e/ \
            -v \
            --tb=short \
            -m "e2e"

      - name: Stop FastAPI server
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi

      - name: Upload E2E test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-backend-reports
          path: |
            tests/e2e/fixtures/
            .pytest_cache/

      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-backend-server-logs
          path: /tmp/server.log
          retention-days: 7

  # ============================================
  # E2E Smoke Tests (Playwright - Chromium only)
  # ============================================
  e2e-smoke-tests:
    name: E2E Smoke Tests (Chromium)
    runs-on: ubuntu-latest
    # Run on PRs for fast feedback
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web-ui/package-lock.json'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install Python dependencies
        run: |
          uv venv
          uv sync

      - name: Install frontend dependencies
        working-directory: web-ui
        run: npm ci

      - name: Install E2E test dependencies
        working-directory: tests/e2e
        run: npm ci

      - name: Install Playwright browsers (Chromium only)
        working-directory: tests/e2e
        run: npx playwright install chromium --with-deps

      - name: Install codeframe package
        run: |
          uv pip install -e .
          echo "✅ Package installed in editable mode"

      - name: Initialize database
        run: |
          mkdir -p .codeframe
          source .venv/bin/activate
          python -c "from codeframe.persistence.database import Database; db = Database('.codeframe/state.db'); db.initialize(); db.close()"
          echo "✅ Database initialized"

      - name: Start backend server
        env:
          DATABASE_PATH: ${{ github.workspace }}/.codeframe/state.db
          WORKSPACE_ROOT: ${{ github.workspace }}
          CODEFRAME_DEPLOYMENT_MODE: self_hosted
        run: |
          source .venv/bin/activate
          python -m uvicorn codeframe.ui.server:app --port 8080 > /tmp/backend.log 2>&1 &
          echo "BACKEND_PID=$!" >> $GITHUB_ENV
          echo "Backend started with PID: $!"

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend to start..."
          for i in {1..120}; do
            if curl -s http://localhost:8080/health > /dev/null; then
              echo "✅ Backend is ready!"
              curl -s http://localhost:8080/health | jq .
              break
            fi
            echo "Attempt $i/120: Backend not ready yet..."
            sleep 1
            if [ $i -eq 120 ]; then
              echo "❌ Backend failed to start within 120 seconds"
              cat /tmp/backend.log
              exit 1
            fi
          done

      - name: Start frontend dev server
        working-directory: web-ui
        run: |
          npm run dev > /tmp/frontend.log 2>&1 &
          echo "FRONTEND_PID=$!" >> $GITHUB_ENV
          echo "Frontend started with PID: $!"

      - name: Wait for frontend to be ready
        run: |
          echo "Waiting for frontend to start..."
          for i in {1..60}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "✅ Frontend is ready!"
              break
            fi
            echo "Attempt $i/60: Frontend not ready yet..."
            sleep 1
            if [ $i -eq 60 ]; then
              echo "❌ Frontend failed to start within 60 seconds"
              cat /tmp/frontend.log
              exit 1
            fi
          done

      - name: Run Playwright smoke tests (Chromium only)
        working-directory: tests/e2e
        run: npm run test:smoke

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: tests/e2e/playwright-report/
          retention-days: 7

      - name: Upload backend logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-backend-logs
          path: /tmp/backend.log
          retention-days: 7

      - name: Upload frontend logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-frontend-logs
          path: /tmp/frontend.log
          retention-days: 7

      - name: Stop servers
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi
          if [ -n "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID || true
          fi

  # ============================================
  # E2E Frontend Tests (Playwright - All Browsers)
  # ============================================
  # COMMENTED OUT: Enable when smoke tests are passing consistently
  # e2e-frontend-tests:
  #   name: E2E Frontend Tests (All Browsers)
  #   runs-on: ubuntu-latest
  #   # Only run on main branch or scheduled runs
  #   if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #         cache-dependency-path: 'web-ui/package-lock.json'
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #
  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v4
  #       with:
  #         enable-cache: true
  #
  #     - name: Install Python dependencies
  #       run: |
  #         uv venv
  #         uv sync
  #
  #     - name: Install frontend dependencies
  #       working-directory: web-ui
  #       run: npm ci
  #
  #     - name: Install E2E test dependencies
  #       working-directory: tests/e2e
  #       run: npm ci
  #
  #     - name: Install Playwright browsers
  #       working-directory: tests/e2e
  #       run: npx playwright install --with-deps
  #
  #     - name: Install codeframe package
  #       run: |
  #         uv pip install -e .
  #         echo "✅ Package installed in editable mode"
  #
  #     - name: Initialize database
  #       run: |
  #         mkdir -p .codeframe
  #         source .venv/bin/activate
  #         python -c "from codeframe.persistence.database import Database; db = Database('.codeframe/state.db'); db.initialize(); db.close()"
  #         echo "✅ Database initialized"
  #
  #     - name: Start backend server
  #       env:
  #         DATABASE_PATH: ${{ github.workspace }}/.codeframe/state.db
  #         WORKSPACE_ROOT: ${{ github.workspace }}
  #         CODEFRAME_DEPLOYMENT_MODE: self_hosted
  #       run: |
  #         source .venv/bin/activate
  #         python -m uvicorn codeframe.ui.server:app --port 8080 > /tmp/backend.log 2>&1 &
  #         echo "BACKEND_PID=$!" >> $GITHUB_ENV
  #         echo "Backend started with PID: $!"
  #
  #     - name: Verify backend startup
  #       run: |
  #         sleep 5
  #         if ! ps -p $BACKEND_PID > /dev/null; then
  #           echo "❌ Backend process died immediately"
  #           cat /tmp/backend.log
  #           exit 1
  #         fi
  #         echo "✅ Backend process is running (PID: $BACKEND_PID)"
  #
  #     - name: Wait for backend to be ready
  #       run: |
  #         echo "Waiting for backend to start..."
  #         for i in {1..120}; do
  #           if curl -s http://localhost:8080/health > /dev/null; then
  #             echo "✅ Backend is ready!"
  #             curl -s http://localhost:8080/health | jq .
  #             break
  #           fi
  #           echo "Attempt $i/120: Backend not ready yet..."
  #           sleep 1
  #           if [ $i -eq 120 ]; then
  #             echo "❌ Backend failed to start within 120 seconds"
  #             echo "=== Backend Logs ==="
  #             cat /tmp/backend.log
  #             exit 1
  #           fi
  #         done
  #
  #     - name: Start frontend dev server
  #       working-directory: web-ui
  #       run: |
  #         npm run dev > /tmp/frontend.log 2>&1 &
  #         echo "FRONTEND_PID=$!" >> $GITHUB_ENV
  #         echo "Frontend started with PID: $!"
  #
  #     - name: Wait for frontend to be ready
  #       run: |
  #         echo "Waiting for frontend to start..."
  #         for i in {1..60}; do
  #           if curl -s http://localhost:3000 > /dev/null; then
  #             echo "✅ Frontend is ready!"
  #             break
  #           fi
  #           echo "Attempt $i/60: Frontend not ready yet..."
  #           sleep 1
  #           if [ $i -eq 60 ]; then
  #             echo "❌ Frontend failed to start within 60 seconds"
  #             echo "=== Frontend Logs ==="
  #             cat /tmp/frontend.log
  #             exit 1
  #           fi
  #         done
  #
  #     - name: Run Playwright E2E tests
  #       working-directory: tests/e2e
  #       run: |
  #         npx playwright test \
  #           --config=playwright.config.ts \
  #           *.spec.ts
  #
  #     - name: Upload Playwright report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: tests/e2e/playwright-report/
  #         retention-days: 30
  #
  #     - name: Upload backend logs
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-frontend-backend-logs
  #         path: /tmp/backend.log
  #         retention-days: 7
  #
  #     - name: Upload frontend logs
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-frontend-frontend-logs
  #         path: /tmp/frontend.log
  #         retention-days: 7
  #
  #     - name: Stop servers
  #       if: always()
  #       run: |
  #         if [ -n "$BACKEND_PID" ]; then
  #           kill $BACKEND_PID || true
  #         fi
  #         if [ -n "$FRONTEND_PID" ]; then
  #           kill $FRONTEND_PID || true
  #         fi

  # ============================================
  # TestSprite E2E Tests (Optional)
  # ============================================
  testsprite-e2e:
    name: TestSprite E2E Tests
    runs-on: ubuntu-latest
    # Only run on scheduled builds (nightly)
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend dependencies
        working-directory: web-ui
        run: npm ci

      - name: Start frontend dev server
        working-directory: web-ui
        run: |
          npm run dev &
          echo "FRONTEND_PID=$!" >> $GITHUB_ENV

      - name: Wait for frontend
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run TestSprite E2E tests
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}
        run: |
          npx @testsprite/testsprite-mcp@latest generateCodeAndExecute

      - name: Upload TestSprite results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testsprite-results
          path: testsprite_tests/

      - name: Stop frontend server
        if: always()
        run: |
          if [ -n "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID || true
          fi

  # ============================================
  # Test Summary
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-quality]
    if: always()

    steps:
      - name: Report test results
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.code-quality.result }}" == "failure" ] || \
             [ "${{ needs.backend-tests.result }}" == "failure" ] || \
             [ "${{ needs.frontend-tests.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some tests failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          fi
